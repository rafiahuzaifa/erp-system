import React, { useState, useEffect, useCallback, useRef } from 'react';
import axios from 'axios';

const API_BASE = process.env.REACT_APP_API_URL || 'http://localhost:3000/api';

// ==================== Shared UI Helpers ====================

function Toast({ toasts, onDismiss }) {
  return (
    <div className="fixed top-4 right-4 z-50 flex flex-col gap-2">
      {toasts.map((t) => (
        <div
          key={t.id}
          className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium transition-all
            ${t.type === 'error' ? 'bg-red-500' : t.type === 'warning' ? 'bg-yellow-500' : 'bg-green-500'}`}
        >
          <span>{t.message}</span>
          <button onClick={() => onDismiss(t.id)} className="ml-2 opacity-75 hover:opacity-100">✕</button>
        </div>
      ))}
    </div>
  );
}

function useToast() {
  const [toasts, setToasts] = useState([]);
  const add = useCallback((message, type = 'success') => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    setTimeout(() => setToasts((prev) => prev.filter((t) => t.id !== id)), 4000);
  }, []);
  const dismiss = useCallback((id) => setToasts((prev) => prev.filter((t) => t.id !== id)), []);
  return { toasts, toast: add, dismiss };
}

function Pagination({ page, pages, total, limit, onPageChange }) {
  if (pages <= 1) return null;
  return (
    <div className="flex items-center justify-between px-4 py-3 border-t border-gray-200">
      <span className="text-sm text-gray-500">
        Showing {Math.min((page - 1) * limit + 1, total)}–{Math.min(page * limit, total)} of {total}
      </span>
      <div className="flex gap-1">
        <button
          onClick={() => onPageChange(page - 1)}
          disabled={page <= 1}
          className="px-3 py-1 text-sm rounded border border-gray-300 disabled:opacity-40 hover:bg-gray-50"
        >
          Prev
        </button>
        {Array.from({ length: Math.min(pages, 7) }, (_, i) => {
          let p = i + 1;
          if (pages > 7) {
            if (page <= 4) p = i + 1;
            else if (page >= pages - 3) p = pages - 6 + i;
            else p = page - 3 + i;
          }
          return (
            <button
              key={p}
              onClick={() => onPageChange(p)}
              className={`px-3 py-1 text-sm rounded border ${
                p === page ? 'bg-indigo-600 text-white border-indigo-600' : 'border-gray-300 hover:bg-gray-50'
              }`}
            >
              {p}
            </button>
          );
        })}
        <button
          onClick={() => onPageChange(page + 1)}
          disabled={page >= pages}
          className="px-3 py-1 text-sm rounded border border-gray-300 disabled:opacity-40 hover:bg-gray-50"
        >
          Next
        </button>
      </div>
    </div>
  );
}

function SortIcon({ field, sortField, sortDir }) {
  if (sortField !== field) return <span className="ml-1 text-gray-300">↕</span>;
  return <span className="ml-1">{sortDir === 'asc' ? '↑' : '↓'}</span>;
}

function exportToCSV(items, entityName) {
  if (!items.length) return;
  const keys = Object.keys(items[0]).filter((k) => k !== '__v');
  const rows = [keys.join(','), ...items.map((item) =>
    keys.map((k) => {
      const v = item[k] == null ? '' : String(item[k]);
      return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v.replace(/"/g, '""')}"` : v;
    }).join(',')
  )];
  const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${entityName}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

{{#each module.entities}}
// ==================== {{pascalCase this.name}} Section ====================

function {{pascalCase this.name}}List({ toast }) {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [pagination, setPagination] = useState({ total: 0, pages: 1 });
  const [sortField, setSortField] = useState('createdAt');
  const [sortDir, setSortDir] = useState('desc');
  const [selected, setSelected] = useState(new Set());
  const [deleting, setDeleting] = useState(false);
  const searchRef = useRef(null);
  const LIMIT = 20;

  const fetchItems = useCallback(async () => {
    setLoading(true);
    try {
      const sort = sortDir === 'asc' ? sortField : `-${sortField}`;
      const res = await axios.get(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}`, {
        params: { page, limit: LIMIT, sort, ...(search ? { search } : {}) }
      });
      setItems(res.data.data || []);
      setPagination(res.data.pagination || { total: 0, pages: 1 });
      setSelected(new Set());
    } catch (err) {
      toast('Failed to load data', 'error');
    } finally {
      setLoading(false);
    }
  }, [page, search, sortField, sortDir]);

  useEffect(() => { fetchItems(); }, [fetchItems]);

  // Debounced search
  useEffect(() => {
    const t = setTimeout(() => setPage(1), 350);
    return () => clearTimeout(t);
  }, [search]);

  const handleSort = (field) => {
    if (sortField === field) setSortDir(d => d === 'asc' ? 'desc' : 'asc');
    else { setSortField(field); setSortDir('asc'); }
    setPage(1);
  };

  const handleDelete = async (id) => {
    if (!window.confirm('Delete this item?')) return;
    try {
      await axios.delete(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}/${id}`);
      toast('Deleted successfully');
      fetchItems();
    } catch (err) {
      toast('Delete failed', 'error');
    }
  };

  const handleBulkDelete = async () => {
    if (!selected.size) return;
    if (!window.confirm(`Delete ${selected.size} selected items?`)) return;
    setDeleting(true);
    try {
      await Promise.all([...selected].map(id =>
        axios.delete(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}/${id}`)
      ));
      toast(`Deleted ${selected.size} items`);
      fetchItems();
    } catch (err) {
      toast('Bulk delete failed', 'error');
    } finally {
      setDeleting(false);
    }
  };

  const toggleSelect = (id) => {
    setSelected(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  const toggleSelectAll = () => {
    if (selected.size === items.length) setSelected(new Set());
    else setSelected(new Set(items.map(i => i._id)));
  };

  const handleExportCSV = async () => {
    try {
      const res = await axios.get(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}`, {
        params: { limit: 10000, sort: `-${sortField}`, ...(search ? { search } : {}) }
      });
      exportToCSV(res.data.data || [], '{{kebabCase (pluralize this.name)}}');
    } catch (err) {
      toast('Export failed', 'error');
    }
  };

  const sortableFields = [{{#each this.fields}}{{#ifNotEq this.type "ObjectId"}}'{{camelCase this.name}}', {{/ifNotEq}}{{/each}}'createdAt'];

  return (
    <div>
      {/* Toolbar */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        <div className="flex items-center gap-2 flex-1 min-w-0">
          <h2 className="text-2xl font-bold text-gray-900 whitespace-nowrap">{{pascalCase (pluralize this.name)}}</h2>
          <span className="text-sm text-gray-400">({pagination.total})</span>
        </div>
        <div className="flex items-center gap-2 flex-wrap">
          <input
            ref={searchRef}
            type="search"
            placeholder="Search..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="border rounded-lg px-3 py-1.5 text-sm w-48 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          {selected.size > 0 && (
            <button
              onClick={handleBulkDelete}
              disabled={deleting}
              className="px-3 py-1.5 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
            >
              Delete {selected.size} selected
            </button>
          )}
          <button
            onClick={handleExportCSV}
            className="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700"
          >
            Export CSV
          </button>
          <button
            onClick={() => { setEditItem(null); setShowForm(true); }}
            className="bg-indigo-600 text-white px-4 py-1.5 text-sm rounded-lg hover:bg-indigo-700"
          >
            + Add {{pascalCase this.name}}
          </button>
        </div>
      </div>

      {showForm && (
        <{{pascalCase this.name}}Form
          item={editItem}
          onSave={() => { setShowForm(false); fetchItems(); toast(editItem ? 'Updated successfully' : 'Created successfully'); }}
          onCancel={() => setShowForm(false)}
          toast={toast}
        />
      )}

      <div className="bg-white shadow rounded-lg overflow-hidden">
        {loading ? (
          <div className="text-center py-10 text-gray-400">Loading...</div>
        ) : (
          <>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 w-10">
                      <input
                        type="checkbox"
                        checked={items.length > 0 && selected.size === items.length}
                        onChange={toggleSelectAll}
                        className="rounded border-gray-300"
                      />
                    </th>
{{#each this.fields}}
{{#ifNotEq this.type "ObjectId"}}
                    <th
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                      onClick={() => handleSort('{{camelCase this.name}}')}
                    >
                      {{this.name}}
                      <SortIcon field="{{camelCase this.name}}" sortField={sortField} sortDir={sortDir} />
                    </th>
{{/ifNotEq}}
{{/each}}
                    <th
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none"
                      onClick={() => handleSort('createdAt')}
                    >
                      Created
                      <SortIcon field="createdAt" sortField={sortField} sortDir={sortDir} />
                    </th>
                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {items.map((item) => (
                    <tr
                      key={item._id}
                      className={`hover:bg-gray-50 ${selected.has(item._id) ? 'bg-indigo-50' : ''}`}
                    >
                      <td className="px-4 py-4">
                        <input
                          type="checkbox"
                          checked={selected.has(item._id)}
                          onChange={() => toggleSelect(item._id)}
                          className="rounded border-gray-300"
                        />
                      </td>
{{#each this.fields}}
{{#ifNotEq this.type "ObjectId"}}
                      <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
{{#ifEq this.type "Boolean"}}
                        <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-medium ${item.{{camelCase this.name}} ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                          {item.{{camelCase this.name}} ? 'Yes' : 'No'}
                        </span>
{{else}}
{{#ifEq this.type "Enum"}}
                        <span className="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                          {item.{{camelCase this.name}} || '—'}
                        </span>
{{else}}
{{#ifEq this.type "Date"}}
                        {item.{{camelCase this.name}} ? new Date(item.{{camelCase this.name}}).toLocaleDateString() : '—'}
{{else}}
                        {String(item.{{camelCase this.name}} ?? '—')}
{{/ifEq}}
{{/ifEq}}
{{/ifEq}}
                      </td>
{{/ifNotEq}}
{{/each}}
                      <td className="px-6 py-4 text-sm text-gray-500">
                        {item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '—'}
                      </td>
                      <td className="px-6 py-4 text-right text-sm whitespace-nowrap">
                        <button
                          onClick={() => { setEditItem(item); setShowForm(true); }}
                          className="text-indigo-600 hover:text-indigo-900 mr-3 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          onClick={() => handleDelete(item._id)}
                          className="text-red-600 hover:text-red-900 font-medium"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {items.length === 0 && (
              <p className="text-center py-10 text-gray-400">
                {search ? `No results for "${search}"` : 'No {{lowerCase (pluralize this.name)}} yet.'}
              </p>
            )}
            <Pagination
              page={page}
              pages={pagination.pages}
              total={pagination.total}
              limit={LIMIT}
              onPageChange={setPage}
            />
          </>
        )}
      </div>
    </div>
  );
}

function {{pascalCase this.name}}Form({ item, onSave, onCancel, toast }) {
  const [form, setForm] = useState(() => item ? { ...item } : {});
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const validate = () => {
    const errs = {};
{{#each this.fields}}
{{#if this.required}}
{{#ifNotEq this.type "ObjectId"}}
    if (!form.{{camelCase this.name}} && form.{{camelCase this.name}} !== 0 && form.{{camelCase this.name}} !== false)
      errs.{{camelCase this.name}} = '{{this.name}} is required';
{{/ifNotEq}}
{{/if}}
{{/each}}
    return errs;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const errs = validate();
    if (Object.keys(errs).length) { setErrors(errs); return; }
    setSaving(true);
    try {
      if (item?._id) {
        await axios.put(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}/${item._id}`, form);
      } else {
        await axios.post(`${API_BASE}/{{kebabCase ../module.name}}/{{kebabCase (pluralize this.name)}}`, form);
      }
      onSave();
    } catch (err) {
      const msg = err.response?.data?.error || 'Save failed';
      toast(msg, 'error');
    } finally {
      setSaving(false);
    }
  };

  const field = (name, children) => (
    <div key={name}>
      <label className="block text-sm font-medium text-gray-700 mb-1">{name}</label>
      {children}
      {errors[name] && <p className="mt-1 text-xs text-red-500">{errors[name]}</p>}
    </div>
  );

  return (
    <div className="bg-white shadow rounded-lg p-6 mb-6 border border-gray-200">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-900">{item ? 'Edit' : 'New'} {{pascalCase this.name}}</h3>
        <button onClick={onCancel} className="text-gray-400 hover:text-gray-600 text-xl leading-none">×</button>
      </div>
      <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
{{#each this.fields}}
{{#ifNotEq this.type "ObjectId"}}
{{#ifEq this.type "Boolean"}}
        <div className="flex items-center gap-2">
          <input
            id="field-{{camelCase this.name}}"
            type="checkbox"
            checked={form.{{camelCase this.name}} || false}
            onChange={e => setForm({...form, {{camelCase this.name}}: e.target.checked})}
            className="rounded border-gray-300 text-indigo-600"
          />
          <label htmlFor="field-{{camelCase this.name}}" className="text-sm font-medium text-gray-700">{{this.name}}</label>
        </div>
{{else}}
{{#ifEq this.type "Enum"}}
        {field('{{this.name}}',
          <select
            value={form.{{camelCase this.name}} || ''}
            onChange={e => { setForm({...form, {{camelCase this.name}}: e.target.value}); setErrors(p => ({...p, {{camelCase this.name}}: ''}})); }}
            className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${errors.{{camelCase this.name}} ? 'border-red-400' : 'border-gray-300'}`}
          >
            <option value="">Select {{this.name}}...</option>
{{#each this.enumValues}}
            <option value="{{this}}">{{this}}</option>
{{/each}}
          </select>
        )}
{{else}}
{{#ifEq this.type "Number"}}
        {field('{{this.name}}',
          <input
            type="number"
            value={form.{{camelCase this.name}} ?? ''}
            onChange={e => { setForm({...form, {{camelCase this.name}}: e.target.value ? Number(e.target.value) : ''}); setErrors(p => ({...p, {{camelCase this.name}}: ''})); }}
            className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${errors.{{camelCase this.name}} ? 'border-red-400' : 'border-gray-300'}`}
            {{#if this.required}}required{{/if}}
          />
        )}
{{else}}
{{#ifEq this.type "Date"}}
        {field('{{this.name}}',
          <input
            type="date"
            value={form.{{camelCase this.name}} ? new Date(form.{{camelCase this.name}}).toISOString().split('T')[0] : ''}
            onChange={e => { setForm({...form, {{camelCase this.name}}: e.target.value}); setErrors(p => ({...p, {{camelCase this.name}}: ''})); }}
            className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${errors.{{camelCase this.name}} ? 'border-red-400' : 'border-gray-300'}`}
            {{#if this.required}}required{{/if}}
          />
        )}
{{else}}
{{#ifEq this.type "Text"}}
        {field('{{this.name}}',
          <textarea
            value={form.{{camelCase this.name}} || ''}
            onChange={e => { setForm({...form, {{camelCase this.name}}: e.target.value}); setErrors(p => ({...p, {{camelCase this.name}}: ''})); }}
            rows={3}
            className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${errors.{{camelCase this.name}} ? 'border-red-400' : 'border-gray-300'}`}
            {{#if this.required}}required{{/if}}
          />
        )}
{{else}}
        {field('{{this.name}}',
          <input
            type="text"
            value={form.{{camelCase this.name}} || ''}
            onChange={e => { setForm({...form, {{camelCase this.name}}: e.target.value}); setErrors(p => ({...p, {{camelCase this.name}}: ''})); }}
            className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${errors.{{camelCase this.name}} ? 'border-red-400' : 'border-gray-300'}`}
            {{#if this.required}}required{{/if}}
          />
        )}
{{/ifEq}}
{{/ifEq}}
{{/ifEq}}
{{/ifEq}}
{{/ifEq}}
{{/ifNotEq}}
{{/each}}
        <div className="md:col-span-2 flex justify-end gap-3 pt-2">
          <button type="button" onClick={onCancel} className="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" disabled={saving} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 disabled:opacity-50">
            {saving ? 'Saving...' : item ? 'Update' : 'Create'}
          </button>
        </div>
      </form>
    </div>
  );
}

{{/each}}

// ==================== Main Page ====================

export default function {{pascalCase module.name}}Page() {
  const [activeTab, setActiveTab] = useState('{{camelCase module.entities.[0].name}}');
  const { toasts, toast, dismiss } = useToast();

  return (
    <div>
      <Toast toasts={toasts} onDismiss={dismiss} />

      <h1 className="text-3xl font-bold text-gray-900 mb-6">{{module.displayName}}</h1>

      <div className="border-b border-gray-200 mb-6">
        <nav className="flex space-x-1">
{{#each module.entities}}
          <button
            onClick={() => setActiveTab('{{camelCase this.name}}')}
            className={`py-2.5 px-5 text-sm font-medium rounded-t-lg transition-colors ${
              activeTab === '{{camelCase this.name}}'
                ? 'bg-white border border-b-white border-gray-200 -mb-px text-indigo-600'
                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
            }`}
          >
            {{pascalCase (pluralize this.name)}}
          </button>
{{/each}}
        </nav>
      </div>

{{#each module.entities}}
      {activeTab === '{{camelCase this.name}}' && <{{pascalCase this.name}}List toast={toast} />}
{{/each}}
    </div>
  );
}
